FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
ARG NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
ARG NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/dashboard
ARG NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/onboarding
ARG NEXT_PUBLIC_APP_URL
ARG NEXT_PUBLIC_PADDLE_CLIENT_TOKEN
ARG NEXT_PUBLIC_PADDLE_ENV
ARG NEXT_PUBLIC_PADDLE_PRICE_BASIS_MONTHLY
ARG NEXT_PUBLIC_PADDLE_PRICE_BASIS_YEARLY
ARG NEXT_PUBLIC_PADDLE_PRICE_PRO_MONTHLY
ARG NEXT_PUBLIC_PADDLE_PRICE_PRO_YEARLY
ARG NEXT_PUBLIC_PADDLE_PRICE_TEAM_MONTHLY
ARG NEXT_PUBLIC_PADDLE_PRICE_TEAM_YEARLY
ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_CLERK_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_SIGN_IN_URL
ENV NEXT_PUBLIC_CLERK_SIGN_UP_URL=$NEXT_PUBLIC_CLERK_SIGN_UP_URL
ENV NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL
ENV NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=$NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL
ENV NEXT_PUBLIC_APP_URL=$NEXT_PUBLIC_APP_URL
ENV NEXT_PUBLIC_PADDLE_CLIENT_TOKEN=$NEXT_PUBLIC_PADDLE_CLIENT_TOKEN
ENV NEXT_PUBLIC_PADDLE_ENV=$NEXT_PUBLIC_PADDLE_ENV
ENV NEXT_PUBLIC_PADDLE_PRICE_BASIS_MONTHLY=$NEXT_PUBLIC_PADDLE_PRICE_BASIS_MONTHLY
ENV NEXT_PUBLIC_PADDLE_PRICE_BASIS_YEARLY=$NEXT_PUBLIC_PADDLE_PRICE_BASIS_YEARLY
ENV NEXT_PUBLIC_PADDLE_PRICE_PRO_MONTHLY=$NEXT_PUBLIC_PADDLE_PRICE_PRO_MONTHLY
ENV NEXT_PUBLIC_PADDLE_PRICE_PRO_YEARLY=$NEXT_PUBLIC_PADDLE_PRICE_PRO_YEARLY
ENV NEXT_PUBLIC_PADDLE_PRICE_TEAM_MONTHLY=$NEXT_PUBLIC_PADDLE_PRICE_TEAM_MONTHLY
ENV NEXT_PUBLIC_PADDLE_PRICE_TEAM_YEARLY=$NEXT_PUBLIC_PADDLE_PRICE_TEAM_YEARLY
RUN npm run build

FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public
# pdfkit is loaded via eval('require') to avoid webpack bundling,
# so Next.js standalone trace does not include it. Install it explicitly.
RUN npm install --no-save pdfkit@0.15.2
EXPOSE 3000
CMD ["node", "server.js"]
